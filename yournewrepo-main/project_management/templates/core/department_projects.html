{% extends 'core/base.html' %}   {# Inherit layout from base.html (navbar, structure, etc.) #}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12 mb-4">
            <!-- Department title -->
            <h2>{{ department_name }} Projects</h2>
            <!-- Back button to department selection page -->
            <a href="{% url 'department_selection' %}" class="btn btn-secondary">Back to Departments</a>
        </div>
    </div>

    <!-- Batch legend (explains colors for A, B, C) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5>Projects by Batch:</h5>
                    <div class="d-flex gap-3">
                        <span class="badge bg-primary">Batch A</span>
                        <span class="badge bg-secondary">Batch B</span>
                        <span class="badge bg-success">Batch C</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Regroup all projects by student batch -->
    {% regroup projects by student.batch as batch_list %}
    
    <!-- Loop through each batch -->
    {% for batch in batch_list|dictsort:"grouper" %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <!-- Batch header with Faculty info -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>
                        <span class="badge 
                            {% if batch.grouper == 'A' %}bg-primary
                            {% elif batch.grouper == 'B' %}bg-secondary
                            {% else %}bg-success{% endif %}">
                            Batch {{ batch.grouper }}
                        </span>
                    </h4>
                    <!-- Show faculty username from the first project in that batch -->
                    <span class="text-muted">Faculty: {{ batch.list.0.student.faculty.user.username }}</span>
                </div>

                <!-- Batch projects -->
                <div class="card-body">
                    <div class="row">
                        {% for project in batch.list %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <!-- Project title -->
                                    <h5 class="card-title">{{ project.title }}</h5>

                                    <!-- Group members list -->
                                    <div class="group-members mb-3">
                                        <h6 class="text-muted mb-2">Group Members:</h6>
                                        <ul class="list-unstyled">
                                            {% for member in project.get_group_members_list %}
                                            <li><i class="bi bi-person"></i> {{ member }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>

                                    <!-- Button to open project details modal -->
                                    <button type="button" class="btn btn-primary mt-auto" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#projectModal{{ project.id }}">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Modal for showing project details -->
                        <div class="modal fade" id="projectModal{{ project.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">{{ project.title }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Group members -->
                                        <div class="mb-4">
                                            <h6>Group Members:</h6>
                                            <ul class="list-unstyled">
                                                {% for member in project.get_group_members_list %}
                                                <li><i class="bi bi-person"></i> {{ member }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>

                                        <!-- Description -->
                                        <div class="mb-4">
                                            <h6>Description:</h6>
                                            <p>{{ project.description }}</p>
                                        </div>

                                        <!-- Optional project video -->
                                        {% if project.video %}
                                        <div class="video-container mt-3">
                                            <video width="100%" controls>
                                                <source src="{{ project.video.url }}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                        </div>
                                        {% endif %}

                                        <!-- Metadata -->
                                        <p class="text-muted mt-3">
                                            Uploaded by: {{ project.student.user.username }} (Batch {{ project.student.batch }})<br>
                                            Date: {{ project.created_at|date:"F d, Y" }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- If no projects exist -->
    {% empty %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                No projects available for this department yet.
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Custom styling -->
<style>
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,0.125);
    }
    .badge {
        font-size: 1rem;
        padding: 8px 16px;
    }
    .modal .badge {
        font-size: 0.875rem;
        padding: 4px 8px;
    }
    .group-members {
        font-size: 0.9rem;
    }
    .group-members li {
        margin-bottom: 0.25rem;
    }
    .bi-person {
        margin-right: 0.5rem;
    }
</style>

<!-- Bootstrap Icons (for person icon etc.) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}
